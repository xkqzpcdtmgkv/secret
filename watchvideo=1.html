<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vescence</title>
</head>
<body>

    <header>
        <h1>vescence</h1>
    </header>

    <main>
        <video width="854" height="480" controls>
            <source src="shiba inu climbing - jhovany argueta (480p, h264).mp4" type="video/mp4">
            your browser does not support the video tag.
        </video>

        <table width="854" border="0">
            <tr>
                <td align="left">
                    <font size="5"><strong>shiba inu climbing</strong> by luxifoo</font><br>
                    <font size="3">uploaded Jan 2, 2011</font>
                </td>
                <td align="right" valign="top">
                    <button type="button" id="likeBtn">like</button> 
                    <span id="likeCount">0</span>
                </td>
            </tr>
        </table>

        <!-- Comments Section -->
        <table width="854" border="0">
            <tr>
                <td align="left">
                    <br>
                    <font size="4"><strong>comments (<span id="totalComments">loading...</span>)</strong></font>
                    <hr align="left" width="100%">
                    
                    <!-- Comment Input Area -->
                    <p>
                        name: <input type="text" id="commentName" placeholder="your name"><br><br>
                        comment: <br>
                        <textarea id="commentText" rows="3" cols="40" placeholder="add a public comment..."></textarea><br>
                        <button type="button" id="postComment">comment</button>
                    </p>

                    <!-- Divider line before comments list -->
                    <hr align="left" width="100%">

                    <!-- Container for new comments -->
                    <div id="commentList"></div>
                </td>
            </tr>
        </table>
    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, updateDoc, serverTimestamp, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your specific Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDtQ6piduopw_nRjLjlGlybwT60ptX57fE",
            authDomain: "vscence-1bcfb.firebaseapp.com",
            projectId: "vscence-1bcfb",
            storageBucket: "vscence-1bcfb.firebasestorage.app",
            messagingSenderId: "1062352337874",
            appId: "1:1062352337874:web:c6bd32a9cef8c759bda60b",
            measurementId: "G-4VSHG2M1LQ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = "vscence-1bcfb"; 
        const commentsPath = `artifacts/${appId}/public/data/comments`;
        const likesPath = `artifacts/${appId}/public/data/likes`;
        const commentsRef = collection(db, commentsPath);
        const likesRef = collection(db, likesPath);

        let currentUser = null;

        // Initialize Auth
        const initAuth = async () => {
            try {
                const cred = await signInAnonymously(auth);
                currentUser = cred.user;
            } catch (err) {
                console.error("Authentication error:", err);
                if (err.code === 'auth/configuration-not-found') {
                    document.getElementById('totalComments').textContent = "Error: Auth Not Enabled";
                }
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                setupDataListener();
                setupLikeListener();
            }
        });

        // Like Button Logic (Firestore Integrated)
        const likeBtn = document.getElementById('likeBtn');
        const likeCountSpan = document.getElementById('likeCount');

        async function setupLikeListener() {
            // Listen to all likes to calculate total
            onSnapshot(likesRef, (snapshot) => {
                likeCountSpan.textContent = snapshot.size;
                
                // Check if the current user has already liked
                const userLiked = snapshot.docs.some(doc => doc.id === currentUser?.uid);
                if (userLiked) {
                    likeBtn.style.fontWeight = 'bold';
                    likeBtn.textContent = 'liked';
                    likeBtn.disabled = true;
                }
            });
        }

        likeBtn.onclick = async function() {
            if (!currentUser) return;
            
            try {
                // Store like using the user's ID as the document ID to prevent duplicate likes from the same person
                const userLikeRef = doc(db, likesPath, currentUser.uid);
                await setDoc(userLikeRef, {
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error("Error liking:", e);
            }
        };

        // UI Helpers
        const totalCommentsSpan = document.getElementById('totalComments');
        const commentList = document.getElementById('commentList');
        const nameInput = document.getElementById('commentName');
        const textInput = document.getElementById('commentText');
        const postBtn = document.getElementById('postComment');

        // Create Comment UI Element
        function renderComment(id, data) {
            const container = document.createElement('div');
            container.style.marginBottom = "15px";
            container.className = "comment-container";
            container.dataset.id = id;
            
            if (data.parentId) {
                container.style.marginLeft = "30px";
                container.style.borderLeft = "1px solid #ddd";
                container.style.paddingLeft = "10px";
            }

            const isOwner = currentUser && data.userId === currentUser.uid;

            const contentWrap = document.createElement('div');
            const commentBody = document.createElement('p');
            commentBody.style.margin = "5px 0";
            
            const textSpan = document.createElement('span');
            textSpan.className = "text-content";
            textSpan.textContent = data.text;

            commentBody.innerHTML = `<strong>${data.name}</strong><br>`;
            commentBody.appendChild(textSpan);
            contentWrap.appendChild(commentBody);
            container.appendChild(contentWrap);

            const actionsArea = document.createElement('div');
            actionsArea.style.marginBottom = "5px";

            const replyBtn = document.createElement('button');
            replyBtn.textContent = "reply";
            replyBtn.style.fontSize = "11px";
            actionsArea.appendChild(replyBtn);

            if (isOwner) {
                const editBtn = document.createElement('button');
                editBtn.textContent = "edit";
                editBtn.style.fontSize = "11px";
                editBtn.style.marginLeft = "5px";

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = "delete";
                deleteBtn.style.fontSize = "11px";
                deleteBtn.style.marginLeft = "5px";

                actionsArea.appendChild(editBtn);
                actionsArea.appendChild(deleteBtn);

                deleteBtn.onclick = async () => {
                    if (confirm("Delete this comment?")) {
                        await deleteDoc(doc(db, commentsPath, id));
                    }
                };

                editBtn.onclick = async () => {
                    const newText = prompt("Edit your comment:", textSpan.textContent);
                    if (newText !== null && newText.trim() !== "") {
                        await updateDoc(doc(db, commentsPath, id), {
                            text: newText
                        });
                    }
                };
            }

            container.appendChild(actionsArea);

            // Reply Box UI
            const replyInputWrap = document.createElement('div');
            replyInputWrap.style.display = "none";
            replyInputWrap.style.marginTop = "10px";
            replyInputWrap.style.padding = "5px";
            replyInputWrap.style.backgroundColor = "#f9f9f9";
            
            const rNameIn = document.createElement('input');
            rNameIn.type = "text";
            rNameIn.placeholder = "name";
            rNameIn.style.fontSize = "11px";
            
            const rTextIn = document.createElement('textarea');
            rTextIn.rows = 2;
            rTextIn.cols = 25;
            rTextIn.placeholder = "write a reply...";
            rTextIn.style.fontSize = "11px";
            rTextIn.style.display = "block";
            rTextIn.style.marginTop = "5px";

            const rSubmit = document.createElement('button');
            rSubmit.textContent = "post reply";
            rSubmit.style.fontSize = "11px";

            const rCancel = document.createElement('button');
            rCancel.textContent = "cancel";
            rCancel.style.fontSize = "11px";
            rCancel.style.marginLeft = "5px";

            replyInputWrap.appendChild(rNameIn);
            replyInputWrap.appendChild(rTextIn);
            replyInputWrap.appendChild(rSubmit);
            replyInputWrap.appendChild(rCancel);
            container.appendChild(replyInputWrap);

            const repliesList = document.createElement('div');
            repliesList.className = "replies-list";
            container.appendChild(repliesList);

            replyBtn.onclick = () => {
                replyInputWrap.style.display = "block";
                replyBtn.style.display = "none";
                rNameIn.value = nameInput.value || "Anonymous";
            };

            rCancel.onclick = () => {
                replyInputWrap.style.display = "none";
                replyBtn.style.display = "inline-block";
            };

            rSubmit.onclick = async () => {
                if (!currentUser) return;
                const rName = rNameIn.value.trim() || "Anonymous";
                const rText = rTextIn.value.trim();
                if (rText) {
                    await addDoc(commentsRef, {
                        name: rName,
                        text: rText,
                        parentId: id,
                        userId: currentUser.uid,
                        timestamp: serverTimestamp()
                    });
                    replyInputWrap.style.display = "none";
                    replyBtn.style.display = "inline-block";
                    rTextIn.value = "";
                }
            };

            return container;
        }

        // Real-time Database Listener
        let unsubscribe = null;
        function setupDataListener() {
            if (unsubscribe) unsubscribe();
            
            unsubscribe = onSnapshot(commentsRef, (snapshot) => {
                const allComments = [];
                snapshot.forEach(doc => allComments.push({ id: doc.id, ...doc.data() }));
                
                // Sort by time
                allComments.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                commentList.innerHTML = '';
                totalCommentsSpan.textContent = allComments.length;

                const commentMap = {};
                
                // Main comments
                allComments.forEach(data => {
                    if (!data.parentId) {
                        const el = renderComment(data.id, data);
                        commentList.prepend(el);
                        commentMap[data.id] = el;
                    }
                });

                // Replies
                allComments.forEach(data => {
                    if (data.parentId && commentMap[data.parentId]) {
                        const el = renderComment(data.id, data);
                        const list = commentMap[data.parentId].querySelector('.replies-list');
                        list.appendChild(el);
                        
                        const directReplies = Array.from(list.children);
                        if (directReplies.length > 1) {
                            el.style.display = "none";
                            let showBtn = commentMap[data.parentId].querySelector('.show-replies-btn');
                            if (!showBtn) {
                                showBtn = document.createElement('button');
                                showBtn.className = 'show-replies-btn';
                                showBtn.textContent = 'show all replies';
                                showBtn.style.fontSize = "11px";
                                showBtn.style.marginLeft = "30px";
                                showBtn.onclick = () => {
                                    Array.from(list.children).forEach(r => r.style.display = 'block');
                                    showBtn.style.display = 'none';
                                };
                                commentMap[data.parentId].appendChild(showBtn);
                            }
                        }
                    }
                });
            }, (error) => {
                console.error("Firestore error:", error);
            });
        }

        // Post main comment
        postBtn.onclick = async function() {
            if (!currentUser) {
                alert("Authenticating... please try again in a second.");
                return;
            }
            const name = nameInput.value.trim() || "Anonymous";
            const text = textInput.value.trim();

            if (text !== "") {
                try {
                    await addDoc(commentsRef, {
                        name: name,
                        text: text,
                        parentId: null,
                        userId: currentUser.uid,
                        timestamp: serverTimestamp()
                    });
                    textInput.value = "";
                } catch (e) {
                    console.error("Error adding comment:", e);
                }
            }
        };
    </script>

</body>
</html>
